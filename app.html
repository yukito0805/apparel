(() => {
  const APP_URL = window.__APP_URL__;

  const teamListEl = document.getElementById("teamList");
  const teamSearchEl = document.getElementById("teamSearch");
  const galleryEl = document.getElementById("gallery");
  const loadingEl = document.getElementById("loading");
  const emptyEl = document.getElementById("empty");
  const currentTeamNameEl = document.getElementById("currentTeamName");
  const currentTeamMetaEl = document.getElementById("currentTeamMeta");
  const downloadZipBtn = document.getElementById("downloadZipBtn");
  const reloadBtn = document.getElementById("reloadBtn");

  const lightbox = document.getElementById("lightbox");
  const lightboxBackdrop = document.getElementById("lightboxBackdrop");
  const lightboxClose = document.getElementById("lightboxClose");
  const lightboxTitle = document.getElementById("lightboxTitle");
  const lightboxImg = document.getElementById("lightboxImg");

  let teams = [];
  let activeTeam = null;

  let nextToken = "";
  let isLoading = false;
  let loadedCount = 0;

  function apiUrl(op, params = {}) {
    const u = new URL(APP_URL);
    u.searchParams.set("action", "api");
    u.searchParams.set("op", op);
    Object.entries(params).forEach(([k, v]) => {
      if (v !== undefined && v !== null) u.searchParams.set(k, String(v));
    });
    return u.toString();
  }

  function imgUrl(fileId, thumb = true) {
    const u = new URL(APP_URL);
    u.searchParams.set("action", "img");
    u.searchParams.set("id", fileId);
    if (thumb) u.searchParams.set("thumb", "1");
    return u.toString();
  }

  function zipUrl(folderId) {
    const u = new URL(APP_URL);
    u.searchParams.set("action", "zip");
    u.searchParams.set("folderId", folderId);
    return u.toString();
  }

  function setLoading(on) { loadingEl.classList.toggle("hidden", !on); }
  function setEmpty(on) { emptyEl.classList.toggle("hidden", !on); }

  function clearGallery() {
    galleryEl.innerHTML = "";
    loadedCount = 0;
  }

  function renderTeams(list) {
    teamListEl.innerHTML = "";
    list.forEach((t) => {
      const item = document.createElement("div");
      item.className = "teamItem" + (activeTeam && activeTeam.id === t.id ? " teamItem--active" : "");

      const badge = document.createElement("div");
      badge.className = "teamBadge";

      const name = document.createElement("div");
      name.className = "teamName";
      name.textContent = t.name;

      item.appendChild(badge);
      item.appendChild(name);

      item.addEventListener("click", () => selectTeam(t));
      teamListEl.appendChild(item);
    });
  }

  async function loadTeams() {
    setLoading(true);
    try {
      const res = await fetch(apiUrl("listTeams"));
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "listTeams failed");
      teams = data.teams || [];
      renderTeams(teams);
    } finally {
      setLoading(false);
    }
  }

  function filterTeams() {
    const q = (teamSearchEl.value || "").trim().toLowerCase();
    if (!q) return renderTeams(teams);
    renderTeams(teams.filter(t => (t.name || "").toLowerCase().includes(q)));
  }

  async function selectTeam(team) {
    activeTeam = team;
    nextToken = "";
    isLoading = false;
    clearGallery();
    setEmpty(false);

    currentTeamNameEl.textContent = team.name;
    currentTeamMetaEl.textContent = "読み込み待機…";
    downloadZipBtn.disabled = false;

    await loadMorePhotos(true);
    renderTeams((teamSearchEl.value || "").trim()
      ? teams.filter(t => (t.name||"").toLowerCase().includes(teamSearchEl.value.trim().toLowerCase()))
      : teams
    );
  }

  async function loadMorePhotos(resetMeta = false) {
    if (!activeTeam || isLoading) return;
    if (nextToken === null) return;

    isLoading = true;
    setLoading(true);

    try {
      const res = await fetch(apiUrl("listPhotos", {
        folderId: activeTeam.id,
        pageToken: nextToken || "",
        pageSize: 60
      }));
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "listPhotos failed");

      const photos = data.photos || [];
      const token = (data.nextToken || "");
      nextToken = token ? token : null;

      if (resetMeta) currentTeamMetaEl.textContent = "";

      if (photos.length === 0 && loadedCount === 0) {
        setEmpty(true);
        currentTeamMetaEl.textContent = "0枚";
        return;
      }

      photos.forEach(addPhotoCard);
      loadedCount += photos.length;

      const moreText = nextToken ? "（スクロールで続き）" : "（全件表示）";
      currentTeamMetaEl.textContent = `${loadedCount}枚表示中 ${moreText}`;
    } finally {
      setLoading(false);
      isLoading = false;
    }
  }

  function addPhotoCard(photo) {
    const card = document.createElement("div");
    card.className = "card";

    const img = document.createElement("img");
    img.className = "thumb";
    img.loading = "lazy";
    img.src = imgUrl(photo.id, true);
    img.alt = photo.name || "";

    const cap = document.createElement("div");
    cap.className = "caption";
    cap.textContent = photo.name || "";

    card.appendChild(img);
    card.appendChild(cap);

    card.addEventListener("click", () => openLightbox(photo));
    galleryEl.appendChild(card);
  }

  function openLightbox(photo) {
    lightboxTitle.textContent = photo.name || "画像";
    lightboxImg.src = imgUrl(photo.id, false);
    lightbox.classList.remove("hidden");
    lightbox.setAttribute("aria-hidden", "false");
  }

  function closeLightbox() {
    lightbox.classList.add("hidden");
    lightbox.setAttribute("aria-hidden", "true");
    lightboxImg.src = "";
  }

  function setupInfiniteScroll() {
    galleryEl.addEventListener("scroll", async () => {
      const nearBottom = galleryEl.scrollTop + galleryEl.clientHeight >= galleryEl.scrollHeight - 400;
      if (nearBottom) await loadMorePhotos();
    });
  }

  function setupEvents() {
    teamSearchEl.addEventListener("input", filterTeams);

    downloadZipBtn.addEventListener("click", () => {
      if (!activeTeam) return;
      window.location.href = zipUrl(activeTeam.id);
    });

    reloadBtn.addEventListener("click", async () => {
      if (!activeTeam) return loadTeams();
      const t = activeTeam;
      await loadTeams();
      const found = teams.find(x => x.id === t.id) || t;
      await selectTeam(found);
    });

    lightboxBackdrop.addEventListener("click", closeLightbox);
    lightboxClose.addEventListener("click", closeLightbox);
    window.addEventListener("keydown", (ev) => {
      if (ev.key === "Escape") closeLightbox();
    });
  }

  async function init() {
    setupEvents();
    setupInfiniteScroll();
    await loadTeams();
  }

  init();
})();
